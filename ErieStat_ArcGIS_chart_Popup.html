<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <script src="js/ba_chart2.js"></script>
    <!--<script src="js/export-csv_glc.js"></script>-->
    <link rel="stylesheet" href="css/BA_Style.css">
    <title>Intro to popups - 4.7</title>

    <style>
        html,
        body,
        #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
        }

        #instruction {
            z-index: 99;
            position: absolute;
            top: 15px;
            left: 50%;
            padding: 5px;
            margin-left: -175px;
            height: 20px;
            width: 350px;
            background: rgba(25, 25, 25, 0.8);
            color: white;
        }
        .esri-popup .esri-popup-header .esri-title {
            font-size: 18px;
            font-weight: bolder;
        }

        .esri-popup .esri-popup-body .esri-popup-content {
            font-size: 14px;
        }

    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://js.arcgis.com/4.7/esri/css/main.css">
    <script src="https://js.arcgis.com/4.7/"></script>

    <script>
        require([
            "esri/tasks/Locator",
            "esri/Map",
            "esri/views/MapView",
            "esri/layers/MapImageLayer",
            "esri/layers/FeatureLayer",
            "esri/geometry/geometryEngine",
            "esri/tasks/IdentifyTask",
            "esri/tasks/support/IdentifyParameters",
            "dojo/_base/array",
            "dojo/dom",
            "dojo/on",
            "dojo/dom-construct",
            "dojo/domReady!"
        ], function(
            Locator,
            Map,
            MapView,
            MapImageLayer,
            FeatureLayer,
            geometryEngine,
            IdentifyTask,
            IdentifyParameters,
            arrayUtils,
            dom,
            on,
            domConstruct
        ) {
            var data;
            $.getJSON("data/all_data.json", function(d){
                data = d;
            });
            var identifyTask, params;
            var serviceURL = "https://gis.glc.org/server/rest/services/ErieStat/PriorityWatersheds/MapServer";
            var metric = metrics.DRP_L_S;
            var unit = units.DRP_L_S;


            var erieStatLayer = new MapImageLayer({
                url: "https://gis.glc.org/server/rest/services/ErieStat/PriorityWatersheds/MapServer",
                id: "esLayer"
            });

            var pilotWatershedLayer = new FeatureLayer({
               url:  "https://gis.glc.org/server/rest/services/ErieStat/PriorityWatersheds/MapServer/1",
            });

            // Create the Map
            var map = new Map({
                basemap: "topo",
            });

            // Create the MapView
            var view = new MapView({
                container: "viewDiv",
                spatialReference: erieStatLayer.spatialReference,
                map: map,
                center: [-82.4301521, 42.2370542],
                zoom: 7
            });

//            map.layers.add(erieStatLayer);
            map.layers.add(pilotWatershedLayer);



            view.on("layerview-create", function(event) {
                if (event.layer.id === "esLayer") {
                    // Explore the properties of the housing layer's layer view here
                    console.log("LayerView for New York housing density created!", event.layerView);
                }
            });

//            on(erieStatLayer, "click", function(){
//                var query = erieStatLayer.createQuery();
//            });

//            on(dom.byId("esLayer"), "click", function(){
//                var query = erieStatLayer.createQuery();
//            })

//            view.on("click", function(event){
//
//                var wellBuffers = geometryEngine.geodesicBuffer(wellPoints, [
//                        50
//                    ], "meters",
//                    true);
//
//                var query = pilotWatershedLayer.createQuery();
//                query.geometry = wellBuffers;
//                query.spatialRelationship = "intersects";
//                var results = pilotWatershedLayer.queryFeatures(query).then(function (response){
//                    view.toTo(response.features.map(function(feature){
//                        return feature.geometry;
//                    }));
//                });
//                console.log(results);
//
//            });
//
//            view.popup.open({
//                title: "test",
//                location: event.mapPoint
//
//            });


//            erieStatLayer.when(function(){
//                view.extent = erieStatLayer.fullExtent;
////                view.goTo(erieStatLayer.fullExtent);
//            });

            view.when(function() {
                // executeIdentifyTask() is called each time the view is clicked
                on(view, "click", executeIdentifyTask);

                // Create identify task for the specified map service
                identifyTask = new IdentifyTask(serviceURL);

                // Set the parameters for the Identify
                params = new IdentifyParameters();
                params.tolerance = 3;
                params.layerIds = [1];
                params.layerOption = "top";
                params.width = view.width;
                params.height = view.height;
            });

            function executeIdentifyTask(event) {

                event.stopPropagation();

//                 Get the coordinates of the click on the view
//                 around the decimals to 3 decimals
//                var lat = Math.round(event.mapPoint.latitude * 1000) / 1000;
//                var lon = Math.round(event.mapPoint.longitude * 1000) / 1000;
//
//                view.popup.open({
//                    // Set the popup's title to the coordinates of the clicked location
//                    title: "Reverse geocode: [" + lon + ", " + lat + "]",
//                    location: event.mapPoint // Set the location of the popup to the clicked location
//                });


                // Set the geometry to the location of the view click
                params.geometry = event.mapPoint;
                params.mapExtent = view.extent;
                dom.byId("viewDiv").style.cursor = "wait";

                identifyTask.execute(params).then(function(response) {
                    if(response == null){
                        return;
                    }
                    var results = response.results;
                    return arrayUtils.map(results, function(result) {

                        var feature = result.feature;
                        var layerName = result.layerName;
                        var w_name = feature.attributes["Watershed Name"];

                        feature.popupTemplate = {
                            title: "{Watershed Name}" + " Watershed",
                            content: "<p>chart goes here</p><div id='chart'></div>"

                        };

                        var w_data = getWatershedMetric(data, w_name, metric);

                        var chart = createChart("chart", "column", "{Watershed Name}" + metric, w_data, ColorPicker.blue7,
                        metric, unit);

//                        feature.attributes.layerName = layerName;
//                        if (layerName === 'Soil Survey Geographic') {
//                            feature.popupTemplate = { // autocasts as new PopupTemplate()
//                                title: "{Map Unit Name}",
//                                content: "<b>Dominant order:</b> {Dominant Order} ({Dom. Cond. Order %}%)" +
//                                "<br><b>Dominant sub-order:</b> {Dominant Sub-Order} ({Dom. Cond. Suborder %}%)" +
//                                "<br><b>Dominant Drainage Class:</b> {Dom. Cond. Drainage Class} ({Dom. Cond. Drainage Class %}%)" +
//                                "<br><b>Farmland Class:</b> {Farmland Class}"
//                            };
//                        }
//                        else if (layerName === 'State Soil Geographic') {
//                            feature.popupTemplate = { // autocasts as new PopupTemplate()
//                                title: "{Map Unit Name}",
//                                content: "<b>Dominant order:</b> {Dominant Order} ({Dominant %}%)" +
//                                "<br><b>Dominant sub-order:</b> {Dominant Sub-Order} ({Dominant Sub-Order %}%)"
//                            };
//                        }
//                        else if (layerName === 'Global Soil Regions') {
//                            feature.popupTemplate = { // autocasts as new PopupTemplate()
//                                title: layerName,
//                                content: "<b>Dominant order:</b> {Dominant Order}" +
//                                "<br><b>Dominant sub-order:</b> {Dominant Sub-Order}"
//                            };
//                        }
                        return feature;
                    });
                }).then(showPopup);

                function showPopup(response) {
                    if (response.length > 0) {
                        view.popup.open({
                            features: response,
                            location: event.mapPoint
                        });
                    }
                    dom.byId("viewDiv").style.cursor = "auto";
                }

            }


        });
    </script>
</head>

<body>
<div id="viewDiv"></div>
<div id="legend">Legend goes here. it is a long <br> paragraph with breaks</div>
<div id="instruction">Click any location on the map to see its street address</div>
</body>

</html>